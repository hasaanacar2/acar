<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orman Erken Uyarƒ± Sistemi</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { 
            margin: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            overflow: hidden;
        }
        #map { 
            height: 100vh; 
            width: 100%; 
        }
        .header { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            z-index: 1000; 
            background: rgba(255,255,255,0.95); 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            max-width: 300px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        .header.minimized {
            transform: translateY(-100%);
            opacity: 0.3;
        }
        .header h2 {
            margin: 0 0 8px 0;
            font-size: 18px;
            color: #2c3e50;
        }
        .header p {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #555;
            line-height: 1.4;
        }
        .status-info {
            font-size: 12px; 
            color: #666; 
            margin-top: 8px;
            line-height: 1.3;
        }
        .header-toggle {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.1);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666;
        }
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            max-width: 200px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        .legend.minimized {
            transform: translateY(100%);
            opacity: 0.3;
        }
        .legend h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #2c3e50;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .legend-color {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            border: 1px solid #333;
            border-radius: 3px;
        }
        .legend p {
            font-size: 11px;
            margin: 10px 0 0 0;
            color: #666;
            line-height: 1.3;
        }
        .legend-toggle {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.1);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666;
        }
        .custom-popup .leaflet-popup-content-wrapper {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            border: 1px solid rgba(0,0,0,0.1);
        }
        .custom-popup .leaflet-popup-content {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .custom-popup .leaflet-popup-tip {
            background: rgba(255, 255, 255, 0.98);
        }
        .popup-content {
            padding: 15px;
            max-width: 350px;
            font-size: 14px;
            line-height: 1.5;
        }
        .popup-title {
            margin: 0 0 12px 0;
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
        }
        .risk-section {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid;
        }
        .risk-combined {
            background-color: #f8f9fa;
            border-left-color: #007bff;
        }
        .risk-weights {
            background-color: #e3f2fd;
            border-left-color: #2196f3;
        }
        .risk-weather {
            background-color: #e8f5e8;
            border-left-color: #4caf50;
        }
        .risk-human {
            background-color: #fff3e0;
            border-left-color: #ff9800;
        }
        .risk-lm {
            background-color: #f3e5f5;
            border-left-color: #9c27b0;
        }
        .fire-warning {
            color: #d32f2f;
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #ffebee;
            border-radius: 5px;
            border-left: 4px solid #d32f2f;
        }
        .spread-warning {
            color: #7b1fa2;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f3e5f5;
            border-radius: 5px;
            border-left: 4px solid #7b1fa2;
        }
        .risk-score {
            font-weight: bold;
            font-size: 15px;
        }
        .weather-data {
            background-color: #e3f2fd;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
        }
        .lm-analysis {
            background-color: #fff8e1;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 13px;
            line-height: 1.6;
            border-left: 4px solid #ffc107;
        }
        .update-time {
            font-size: 11px;
            color: #666;
            margin-top: 12px;
            text-align: center;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }
        
        /* Mobil uyumluluk */
        @media (max-width: 768px) {
            .header {
                top: 5px;
                left: 5px;
                right: 5px;
                max-width: none;
                padding: 10px;
            }
            .header h2 {
                font-size: 14px;
            }
            .header p {
                font-size: 12px;
            }
            .legend {
                bottom: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                padding: 10px;
            }
            .legend h4 {
                font-size: 12px;
            }
            .legend-item {
                font-size: 11px;
            }
            .popup-content {
                max-width: 280px;
                font-size: 12px;
                padding: 10px;
            }
            .popup-title {
                font-size: 14px;
            }
            .fire-warning {
                font-size: 13px;
            }
            .spread-warning {
                font-size: 12px;
            }
            .risk-section {
                padding: 8px;
                margin-bottom: 8px;
            }
            .weather-data {
                padding: 6px;
                font-size: 11px;
            }
            .lm-analysis {
                padding: 8px;
                font-size: 11px;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 8px;
            }
            .header h2 {
                font-size: 13px;
            }
            .header p {
                font-size: 11px;
            }
            .legend {
                padding: 8px;
            }
            .legend h4 {
                font-size: 11px;
            }
            .legend-item {
                font-size: 10px;
            }
            .popup-content {
                max-width: 250px;
                font-size: 11px;
                padding: 8px;
            }
            .popup-title {
                font-size: 13px;
            }
            .risk-section {
                padding: 6px;
                margin-bottom: 6px;
            }
            .weather-data {
                padding: 4px;
                font-size: 10px;
            }
            .lm-analysis {
                padding: 6px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="header-toggle" onclick="toggleHeader()" title="Ba≈ülƒ±ƒüƒ± gizle/g√∂ster">‚àí</button>
        <h2>üå≤ Orman Yangƒ±nƒ± Risk Haritasƒ±</h2>
        <p>Yapay zeka destekli erken uyarƒ± sistemi ile risk analizi</p>
        <div id="cache-status" class="status-info">
            Cache durumu y√ºkleniyor...
        </div>
        <div id="analysis-status" class="status-info">
            Analiz durumu kontrol ediliyor...
        </div>
        <div id="render-info" class="status-info" style="color: #ff9800; font-size: 10px;">
            ‚ö†Ô∏è Akƒ±llƒ± analiz sistemi (hava durumu + localStorage)
        </div>
        <div id="weather-update-info" class="status-info" style="color: #2196f3; font-size: 10px; display: none;">
            üîÑ Yeni hava durumu verisi tespit edildi - Cache temizleniyor...
        </div>
        <div id="lm-analysis-status" class="status-info" style="display: none;">
            ü§ñ LM Analizi: <span id="lm-status-text">Kontrol ediliyor...</span>
        </div>
    </div>
    
    <div id="map"></div>
    
    <div class="legend">
        <button class="legend-toggle" onclick="toggleLegend()" title="A√ßƒ±klamayƒ± gizle/g√∂ster">‚àí</button>
        <h4>üéØ Risk Seviyeleri</h4>
        <div class="legend-item">
            <div class="legend-color" style="background-color: green;"></div>
            <span>D√º≈ü√ºk Risk</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: lightgreen;"></div>
            <span>D√º≈ü√ºk-Orta Risk</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: yellow;"></div>
            <span>Orta Risk</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: orange;"></div>
            <span>Orta-Y√ºksek Risk</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: red;"></div>
            <span>Y√ºksek Risk</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: darkred;"></div>
            <span>√áok Y√ºksek Risk</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: purple; border: 2px dashed #333;"></div>
            <span>Yayƒ±lma Riski</span>
        </div>
        <p>üìç Alanlara dokunarak detaylƒ± bilgi alabilirsiniz</p>
    </div>
    
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Header ve legend toggle fonksiyonlarƒ±
        function toggleHeader() {
            const header = document.querySelector('.header');
            const toggleBtn = document.querySelector('.header-toggle');
            header.classList.toggle('minimized');
            toggleBtn.textContent = header.classList.contains('minimized') ? '+' : '‚àí';
        }
        
        function toggleLegend() {
            const legend = document.querySelector('.legend');
            const toggleBtn = document.querySelector('.legend-toggle');
            legend.classList.toggle('minimized');
            toggleBtn.textContent = legend.classList.contains('minimized') ? '+' : '‚àí';
        }
        
                        // Analiz durumunu localStorage'dan kontrol et
                function getAnalysisStatus() {
                    const status = localStorage.getItem('analysis_status');
                    return status ? JSON.parse(status) : { 
                        lastUpdate: null, 
                        analyzedAreas: [],
                        weatherDate: null,
                        lastWeatherCheck: null
                    };
                }
                
                // Analiz durumunu localStorage'a kaydet
                function saveAnalysisStatus(analyzedAreas, weatherDate = null) {
                    const status = {
                        lastUpdate: new Date().toISOString(),
                        analyzedAreas: analyzedAreas,
                        weatherDate: weatherDate,
                        lastWeatherCheck: new Date().toISOString()
                    };
                    localStorage.setItem('analysis_status', JSON.stringify(status));
                }
                
                // Hava durumu tarihini kontrol et
                function checkWeatherDateChange(currentWeatherDate) {
                    const status = getAnalysisStatus();
                    const lastWeatherDate = status.weatherDate;
                    
                    if (lastWeatherDate !== currentWeatherDate) {
                        console.log(`üîÑ Hava durumu tarihi deƒüi≈üti: ${lastWeatherDate} -> ${currentWeatherDate}`);
                        // localStorage'ƒ± temizle
                        localStorage.removeItem('analysis_status');
                        return true; // Deƒüi≈üiklik var
                    }
                    return false; // Deƒüi≈üiklik yok
                }
                
                // Cache durumunu g√ºncelle
                async function updateCacheStatus() {
                    try {
                        const cacheStatusElement = document.getElementById('cache-status');
                        if (!cacheStatusElement) {
                            console.warn('cache-status elementi bulunamadƒ±');
                            return;
                        }
                        
                        const response = await fetch('/cache_stats');
                        const stats = await response.json();
                        const total = stats.total_entries;
                        const valid = stats.valid_entries;
                        const expired = stats.expired_entries;
                let statusText = `üìä Cache: ${valid} ge√ßerli`;
                if (expired > 0) {
                    statusText += `, ${expired} s√ºresi dolmu≈ü`;
                }
                if (total > 0) {
                    const hitRate = Math.round((valid / total) * 100);
                    statusText += ` (${hitRate}% hit rate)`;
                }
                cacheStatusElement.innerHTML = statusText;
            } catch (error) {
                const cacheStatusElement = document.getElementById('cache-status');
                if (cacheStatusElement) {
                    cacheStatusElement.innerHTML = '‚ùå Cache durumu alƒ±namadƒ±';
                }
            }
        }

                        // Analiz durumunu g√ºncelle
                async function updateAnalysisStatus() {
                    try {
                        const analysisStatusElement = document.getElementById('analysis-status');
                        const lmStatusDiv = document.getElementById('lm-analysis-status');
                        const lmStatusText = document.getElementById('lm-status-text');
                        const weatherUpdateDiv = document.getElementById('weather-update-info');
                        
                        if (!analysisStatusElement) {
                            console.warn('analysis-status elementi bulunamadƒ±');
                            return;
                        }
                        
                        const response = await fetch('/analysis_status');
                        const status = await response.json();
                        const stats = status.cache_stats;
                        
                        // localStorage durumunu da kontrol et
                        const localStatus = getAnalysisStatus();
                        const localCount = localStatus.analyzedAreas ? localStatus.analyzedAreas.length : 0;
                        const localWeatherDate = localStatus.weatherDate;
                        
                        let statusText = `üü¢ Sunucu √ßalƒ±≈üƒ±yor`;
                        if (stats.valid_entries > 0) {
                            statusText += ` - ${stats.valid_entries} analiz hazƒ±r`;
                        }
                        if (localCount > 0) {
                            statusText += ` - ${localCount} localStorage`;
                            if (localWeatherDate) {
                                statusText += ` (${localWeatherDate})`;
                            }
                        }
                        analysisStatusElement.innerHTML = statusText;
                        
                        // Hava durumu g√ºncelleme durumunu kontrol et
                        const weatherUpdate = status.weather_update;
                        if (weatherUpdate && weatherUpdateDiv) {
                            if (weatherUpdate.cache_cleared && weatherUpdate.last_weather_date) {
                                weatherUpdateDiv.style.display = 'block';
                                weatherUpdateDiv.innerHTML = `üîÑ Yeni hava durumu verisi: ${weatherUpdate.last_weather_date} - Cache temizlendi`;
                            } else {
                                weatherUpdateDiv.style.display = 'none';
                            }
                        }
                        
                        // LM analizi durumunu kontrol et
                        const lmStatus = status.lm_analysis_status;
                        if (lmStatus && lmStatusDiv && lmStatusText) {
                            lmStatusDiv.style.display = 'block';
                            if (lmStatus.running) {
                                lmStatusText.innerHTML = 'üîÑ √áalƒ±≈üƒ±yor...';
                                lmStatusText.style.color = '#ff9800';
                            } else if (lmStatus.completed) {
                                lmStatusText.innerHTML = '‚úÖ Tamamlandƒ±';
                                lmStatusText.style.color = '#4caf50';
                            } else {
                                lmStatusText.innerHTML = '‚è∏Ô∏è Bekliyor';
                                lmStatusText.style.color = '#666';
                            }
                        } else if (lmStatusDiv) {
                            lmStatusDiv.style.display = 'none';
                        }
                    } catch (error) {
                        const analysisStatusElement = document.getElementById('analysis-status');
                        const lmStatusDiv = document.getElementById('lm-analysis-status');
                        const weatherUpdateDiv = document.getElementById('weather-update-info');
                        
                        if (analysisStatusElement) {
                            analysisStatusElement.innerHTML = '‚ùå Analiz durumu alƒ±namadƒ±';
                        }
                        if (lmStatusDiv) {
                            lmStatusDiv.style.display = 'none';
                        }
                        if (weatherUpdateDiv) {
                            weatherUpdateDiv.style.display = 'none';
                        }
                    }
                }

        // T√ºrkiye'nin merkez koordinatlarƒ±
        var map = L.map('map').setView([39.0, 35.0], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '¬© OpenStreetMap katkƒ±cƒ±larƒ±'
        }).addTo(map);

        // Cache ve analiz durumunu ba≈ülangƒ±√ßta g√ºncelle
        setTimeout(() => {
            updateCacheStatus();
            updateAnalysisStatus();
        }, 1000); // 1 saniye bekle
        
        // Periyodik g√ºncelleme (5 saniyede bir)
        setInterval(() => {
            updateCacheStatus();
        }, 5000);
        setInterval(() => {
            updateAnalysisStatus();
        }, 5000);

        // En g√ºncel GeoJSON dosyasƒ±nƒ± al ve y√ºkle
        console.log('GeoJSON dosyasƒ± y√ºkleniyor...');
        fetch('/get_latest_geojson')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Backend hatasƒ±: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`GeoJSON dosyasƒ± y√ºkleniyor: ${data.filename}`);
                if (!data.url) {
                    throw new Error('GeoJSON URL bulunamadƒ±');
                }
                return fetch(data.url);
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`GeoJSON dosyasƒ± hatasƒ±: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const featureLayer = L.geoJSON(data, {
                    style: function(feature) {
                        return {
                            color: '#888',
                            fillColor: '#888',
                            weight: 2,
                            fillOpacity: 0.5
                        };
                    },
                    onEachFeature: function (feature, layer) {
                        layer.bindPopup('<div class="popup-content"><div style="text-align: center; color: #666;">üìä Analiz y√ºkleniyor...</div></div>', {
                            maxWidth: 400,
                            className: 'custom-popup'
                        });
                        
                        layer.on('popupopen', function(e) {
                            const popup = layer.getPopup();
                            if (feature.properties._dynamic_risk) {
                                const data = feature.properties._dynamic_risk;
                                let fireWarn = '';
                                if (data.fire_status === 'active') {
                                    fireWarn = `<div class="fire-warning">üî• Bu alanda <u>aktif yangƒ±n</u> var!</div>`;
                                } else if (data.fire_spread_risk) {
                                    fireWarn = `<div class="spread-warning">‚ö†Ô∏è Bu alan <u>yangƒ±nƒ±n yayƒ±labileceƒüi riskli b√∂lgedir!</u></div>`;
                                }
                                
                                let lmExplanation = '';
                                if (data.analysis) {
                                    lmExplanation = `
                                        <div class="lm-analysis">
                                            <strong>ü§ñ Yapay Zeka Analizi:</strong><br>
                                            ${data.analysis}
                                        </div>
                                    `;
                                }
                                
                                popup.setContent(`
                                    <div class="popup-content">
                                        ${fireWarn}
                                        <h3 class="popup-title">${data.area_type || 'Orman Alanƒ±'}</h3>
                                        
                                        <div class="risk-section risk-combined">
                                            <strong>üéØ Birle≈ütirilmi≈ü Risk:</strong> 
                                            <span class="risk-score" style="color: ${data.combined_risk_color};">
                                                ${data.combined_risk_level} (${data.combined_risk_score})
                                            </span>
                                        </div>
                                        
                                        <div class="risk-section risk-weights">
                                            <strong>‚öñÔ∏è Dinamik Aƒüƒ±rlƒ±klar:</strong><br>
                                            üå§Ô∏è Hava Durumu: %${data.weather_weight}<br>
                                            üë• ƒ∞nsan Fakt√∂r√º: %${data.human_weight}<br>
                                            üèôÔ∏è En Yakƒ±n ≈ûehir: ${data.nearest_city} (${data.distance_from_city} km)<br>
                                            üèûÔ∏è Alan Tipi: ${data.area_type}<br>
                                            üìè Alan B√ºy√ºkl√ºƒü√º: ${data.area_size}
                                        </div>
                                        
                                        <div class="risk-section risk-weather">
                                            <strong>üå§Ô∏è Hava Durumu Risk:</strong> ${data.weather_risk_score}
                                            <div class="weather-data">
                                                üå°Ô∏è Sƒ±caklƒ±k: ${data.weather_data.sicaklik}¬∞C<br>
                                                üíß Nem: ${data.weather_data.nem}%<br>
                                                üí® R√ºzgar: ${data.weather_data.ruzgar_hizi} km/h<br>
                                                üåßÔ∏è Yaƒüƒ±≈ü: ${data.weather_data.yagis_7_gun} mm
                                            </div>
                                        </div>
                                        
                                        <div class="risk-section risk-human">
                                            <strong>üë• ƒ∞nsan Kaynaklƒ± Risk:</strong> ${data.human_risk_score}
                                            ${data.human_risk_explanation ? `<div style="font-size: 12px; color: #666; margin-top: 5px; font-style: italic;">${data.human_risk_explanation}</div>` : ''}
                                        </div>
                                        
                                        ${lmExplanation}
                                        
                                        <div class="update-time">
                                            üîÑ Son g√ºncelleme: ${new Date().toLocaleString('tr-TR')}
                                        </div>
                                    </div>
                                `);
                                popup.update();
                            } else {
                                popup.setContent(`
                                    <div class="popup-content">
                                        <h3 class="popup-title">${feature.properties.name || 'Orman Alanƒ±'}</h3>
                                        <div style="padding: 15px; background-color: #f0f0f0; border-radius: 8px; text-align: center;">
                                            <div style="color: #666; font-size: 14px;">‚è≥ Analiz yapƒ±lƒ±yor...</div>
                                            <div style="margin-top: 8px; font-size: 12px; color: #999;">Bu alan i√ßin risk analizi hen√ºz tamamlanmadƒ±.</div>
                                        </div>
                                    </div>
                                `);
                                popup.update();
                            }
                        });
                    }
                }).addTo(map);
                
                const features = featureLayer.getLayers();
                let analyzedCount = 0;
                let cachedCount = 0;
                
                function updateLayerStyle(layer, data) {
                    if (data.fire_status === 'active') {
                        layer.setStyle({ 
                            color: 'red', 
                            weight: 4, 
                            dashArray: '5,5', 
                            fillColor: 'red',
                            fillOpacity: 0.7 
                        });
                    } else if (data.fire_spread_risk) {
                        layer.setStyle({ 
                            color: 'purple', 
                            weight: 4, 
                            dashArray: '2,8', 
                            fillColor: 'purple',
                            fillOpacity: 0.6 
                        });
                    } else {
                        let renk = 'green';
                        if (data.combined_risk_level === '√áok Y√ºksek') renk = 'darkred';
                        else if (data.combined_risk_level === 'Y√ºksek') renk = 'red';
                        else if (data.combined_risk_level === 'Orta-Y√ºksek') renk = 'orange';
                        else if (data.combined_risk_level === 'Orta') renk = 'yellow';
                        else if (data.combined_risk_level === 'D√º≈ü√ºk-Orta') renk = 'lightgreen';
                        else renk = 'green';
                        layer.setStyle({ 
                            color: renk, 
                            fillColor: renk,
                            fillOpacity: 0.6,
                            weight: 2
                        });
                    }
                    
                    const popup = layer.getPopup();
                    if (popup && popup.isOpen()) {
                        let fireWarn = '';
                        if (data.fire_status === 'active') {
                            fireWarn = `<div class="fire-warning">üî• Bu alanda <u>aktif yangƒ±n</u> var!</div>`;
                        } else if (data.fire_spread_risk) {
                            fireWarn = `<div class="spread-warning">‚ö†Ô∏è Bu alan <u>yangƒ±nƒ±n yayƒ±labileceƒüi riskli b√∂lgedir!</u></div>`;
                        }
                        
                        let lmExplanation = '';
                        if (data.analysis) {
                            lmExplanation = `
                                <div class="lm-analysis">
                                    <strong>ü§ñ Yapay Zeka Analizi:</strong><br>
                                    ${data.analysis}
                                </div>
                            `;
                        }
                        
                        popup.setContent(`
                            <div class="popup-content">
                                ${fireWarn}
                                <h3 class="popup-title">${data.area_type || 'Orman Alanƒ±'}</h3>
                                
                                <div class="risk-section risk-combined">
                                    <strong>üéØ Birle≈ütirilmi≈ü Risk:</strong> 
                                    <span class="risk-score" style="color: ${data.combined_risk_color};">
                                        ${data.combined_risk_level} (${data.combined_risk_score})
                                    </span>
                                </div>
                                
                                <div class="risk-section risk-weights">
                                    <strong>‚öñÔ∏è Dinamik Aƒüƒ±rlƒ±klar:</strong><br>
                                    üå§Ô∏è Hava Durumu: %${data.weather_weight}<br>
                                    üë• ƒ∞nsan Fakt√∂r√º: %${data.human_weight}<br>
                                    üèôÔ∏è En Yakƒ±n ≈ûehir: ${data.nearest_city} (${data.distance_from_city} km)<br>
                                    üèûÔ∏è Alan Tipi: ${data.area_type}<br>
                                    üìè Alan B√ºy√ºkl√ºƒü√º: ${data.area_size}
                                </div>
                                
                                <div class="risk-section risk-weather">
                                    <strong>üå§Ô∏è Hava Durumu Risk:</strong> ${data.weather_risk_score}
                                    <div class="weather-data">
                                        üå°Ô∏è Sƒ±caklƒ±k: ${data.weather_data.sicaklik}¬∞C<br>
                                        üíß Nem: ${data.weather_data.nem}%<br>
                                        üí® R√ºzgar: ${data.weather_data.ruzgar_hizi} km/h<br>
                                        üåßÔ∏è Yaƒüƒ±≈ü: ${data.weather_data.yagis_7_gun} mm
                                    </div>
                                </div>
                                
                                <div class="risk-section risk-human">
                                    <strong>üë• ƒ∞nsan Kaynaklƒ± Risk:</strong> ${data.human_risk_score}
                                    ${data.human_risk_explanation ? `<div style="font-size: 12px; color: #666; margin-top: 5px; font-style: italic;">${data.human_risk_explanation}</div>` : ''}
                                </div>
                                
                                ${lmExplanation}
                                
                                <div class="update-time">
                                    üîÑ Son g√ºncelleme: ${new Date().toLocaleString('tr-TR')}
                                </div>
                            </div>
                        `);
                        popup.update();
                    }
                }

                async function loadAllAnalyses() {
                    console.log("üîÑ Backend'den t√ºm alanlar analiz ediliyor...");
                    
                    try {
                        // Backend'den t√ºm analizleri iste
                        const response = await fetch('/analyze_all_areas', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            console.log(`‚úÖ ${result.analyzed_areas}/${result.total_areas} alan analiz edildi`);
                            
                            // Sonu√ßlarƒ± haritaya uygula
                            result.results.forEach(item => {
                                const layer = features[item.index];
                                if (layer) {
                                    // Analiz verisini layer'a kaydet
                                    layer.feature.properties._dynamic_risk = item.data;
                                    
                                    // Stili g√ºncelle
                                    updateLayerStyle(layer, item.data);
                                    
                                    // Popup'ƒ± g√ºncelle
                                    updatePopupContent(layer, item.data);
                                    
                                    if (item.cached) {
                                        console.log(`Cache hit: ${item.name}`);
                                    } else {
                                        console.log(`Yeni analiz: ${item.name}`);
                                    }
                                }
                            });
                            
                            // localStorage'a kaydet
                            const analyzedAreas = result.results.map(item => item.index);
                            saveAnalysisStatus(analyzedAreas);
                            console.log(`${analyzedAreas.length} alan localStorage'a kaydedildi`);
                            
                        } else {
                            console.error("Backend analiz hatasƒ±:", result.error);
                        }
                        
                    } catch (error) {
                        console.error("Analiz y√ºkleme hatasƒ±:", error);
                    }
                }
                
                // Popup i√ßeriƒüini g√ºncelle
                function updatePopupContent(layer, data) {
                    const props = layer.feature.properties;
                    const riskLevel = data.combined_risk_level || 'Bilinmiyor';
                    const riskScore = data.combined_risk_score || 0;
                    const riskColor = data.combined_risk_color || 'gray';
                    
                    const popupContent = `
                        <div class="popup-content">
                            <h3 class="popup-title">${props.name || 'Orman Alanƒ±'}</h3>
                            <div class="risk-section risk-combined">
                                <div class="risk-score" style="color: ${riskColor};">
                                    üéØ Risk Seviyesi: ${riskLevel} (${riskScore}/100)
                                </div>
                            </div>
                            <div class="weather-data">
                                <strong>Hava Durumu:</strong><br>
                                üå°Ô∏è Sƒ±caklƒ±k: ${data.weather_data?.sicaklik || 0}¬∞C<br>
                                üíß Nem: ${data.weather_data?.nem || 0}%<br>
                                üí® R√ºzgar: ${data.weather_data?.ruzgar_hizi || 0} km/h
                            </div>
                            <div class="lm-analysis">
                                <strong>ü§ñ Yapay Zeka Analizi:</strong><br>
                                ${data.analysis || 'Analiz mevcut deƒüil'}
                            </div>
                            <div class="update-time">
                                Son g√ºncelleme: ${new Date().toLocaleString('tr-TR')}
                            </div>
                        </div>
                    `;
                    
                    layer.bindPopup(popupContent, {
                        maxWidth: 400,
                        className: 'custom-popup'
                    });
                }
                
                // Analiz ba≈ülat
                setTimeout(() => {
                    loadAllAnalyses().then(() => {
                        updateCacheStatus();
                        updateAnalysisStatus();
                        console.log("‚úÖ T√ºm analizler tamamlandƒ±!");
                    }).catch(err => {
                        console.error('Analiz hatasƒ±:', err);
                    });
                }, 100);
            })
            .catch(error => {
                console.error('Harita y√ºkleme hatasƒ±:', error);
                
                // Daha detaylƒ± hata mesajƒ±
                let errorMessage = '‚ùå Harita verileri y√ºklenemedi.';
                if (error.message.includes('Backend hatasƒ±')) {
                    errorMessage += '<br><br>üîß Sunucu baƒülantƒ±sƒ± kurulamadƒ±. L√ºtfen daha sonra tekrar deneyin.';
                } else if (error.message.includes('GeoJSON dosyasƒ± hatasƒ±')) {
                    errorMessage += '<br><br>üìÅ Harita dosyasƒ± bulunamadƒ±. L√ºtfen daha sonra tekrar deneyin.';
                } else if (error.message.includes('Network')) {
                    errorMessage += '<br><br>üåê ƒ∞nternet baƒülantƒ±sƒ± sorunu. L√ºtfen baƒülantƒ±nƒ±zƒ± kontrol edin.';
                } else {
                    errorMessage += '<br><br>‚ö†Ô∏è Beklenmeyen bir hata olu≈ütu. L√ºtfen daha sonra tekrar deneyin.';
                }
                
                document.body.innerHTML = `<div style="color:red;font-size:18px;text-align:center;margin-top:40px;padding:20px;">${errorMessage}</div>`;
            });
    });
    </script>
</body>
</html> 