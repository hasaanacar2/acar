<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orman Erken UyarÄ± Sistemi</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { 
            margin: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            overflow: hidden;
        }
        #map { 
            height: 100vh; 
            width: 100%; 
        }
        .header { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            z-index: 1000; 
            background: rgba(255,255,255,0.95); 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            max-width: 300px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        .header.minimized {
            transform: translateY(-100%);
            opacity: 0.3;
        }
        .header h2 {
            margin: 0 0 8px 0;
            font-size: 18px;
            color: #2c3e50;
        }
        .header p {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #555;
            line-height: 1.4;
        }
        .status-info {
            font-size: 12px; 
            color: #666; 
            margin-top: 8px;
            line-height: 1.3;
        }
        .header-toggle {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.1);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666;
        }
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            max-width: 200px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        .legend.minimized {
            transform: translateY(100%);
            opacity: 0.3;
        }
        .legend h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #2c3e50;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .legend-color {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            border: 1px solid #333;
            border-radius: 3px;
        }
        .legend p {
            font-size: 11px;
            margin: 10px 0 0 0;
            color: #666;
            line-height: 1.3;
        }
        .legend-toggle {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.1);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666;
        }
        .custom-popup .leaflet-popup-content-wrapper {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            border: 1px solid rgba(0,0,0,0.1);
        }
        .custom-popup .leaflet-popup-content {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .custom-popup .leaflet-popup-tip {
            background: rgba(255, 255, 255, 0.98);
        }
        .popup-content {
            padding: 15px;
            max-width: 350px;
            font-size: 14px;
            line-height: 1.5;
        }
        .popup-title {
            margin: 0 0 12px 0;
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
        }
        .risk-section {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid;
        }
        .risk-combined {
            background-color: #f8f9fa;
            border-left-color: #007bff;
        }
        .risk-weights {
            background-color: #e3f2fd;
            border-left-color: #2196f3;
        }
        .risk-weather {
            background-color: #e8f5e8;
            border-left-color: #4caf50;
        }
        .risk-human {
            background-color: #fff3e0;
            border-left-color: #ff9800;
        }
        .risk-lm {
            background-color: #f3e5f5;
            border-left-color: #9c27b0;
        }
        .fire-warning {
            color: #d32f2f;
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #ffebee;
            border-radius: 5px;
            border-left: 4px solid #d32f2f;
        }
        .spread-warning {
            color: #7b1fa2;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f3e5f5;
            border-radius: 5px;
            border-left: 4px solid #7b1fa2;
        }
        .risk-score {
            font-weight: bold;
            font-size: 15px;
        }
        .weather-data {
            background-color: #e3f2fd;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
        }
        .lm-analysis {
            background-color: #fff8e1;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 13px;
            line-height: 1.6;
            border-left: 4px solid #ffc107;
        }
        .update-time {
            font-size: 11px;
            color: #666;
            margin-top: 12px;
            text-align: center;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }
        
        /* Mobil uyumluluk */
        @media (max-width: 768px) {
            .header {
                top: 5px;
                left: 5px;
                right: 5px;
                max-width: none;
                padding: 10px;
            }
            .header h2 {
                font-size: 14px;
            }
            .header p {
                font-size: 12px;
            }
            .legend {
                bottom: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                padding: 10px;
            }
            .legend h4 {
                font-size: 12px;
            }
            .legend-item {
                font-size: 11px;
            }
            .popup-content {
                max-width: 280px;
                font-size: 12px;
                padding: 10px;
            }
            .popup-title {
                font-size: 14px;
            }
            .fire-warning {
                font-size: 13px;
            }
            .spread-warning {
                font-size: 12px;
            }
            .risk-section {
                padding: 8px;
                margin-bottom: 8px;
            }
            .weather-data {
                padding: 6px;
                font-size: 11px;
            }
            .lm-analysis {
                padding: 8px;
                font-size: 11px;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 8px;
            }
            .header h2 {
                font-size: 13px;
            }
            .header p {
                font-size: 11px;
            }
            .legend {
                padding: 8px;
            }
            .legend h4 {
                font-size: 11px;
            }
            .legend-item {
                font-size: 10px;
            }
            .popup-content {
                max-width: 250px;
                font-size: 11px;
                padding: 8px;
            }
            .popup-title {
                font-size: 13px;
            }
            .risk-section {
                padding: 6px;
                margin-bottom: 6px;
            }
            .weather-data {
                padding: 4px;
                font-size: 10px;
            }
            .lm-analysis {
                padding: 6px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="header-toggle" onclick="toggleHeader()" title="BaÅŸlÄ±ÄŸÄ± gizle/gÃ¶ster">âˆ’</button>
        <h2>ğŸŒ² Orman YangÄ±nÄ± Risk HaritasÄ±</h2>
        <p>Yapay zeka destekli erken uyarÄ± sistemi ile risk analizi</p>
        <div id="cache-status" class="status-info">
            Cache durumu yÃ¼kleniyor...
        </div>
        <div id="analysis-status" class="status-info">
            Analiz durumu kontrol ediliyor...
        </div>
        <div id="lm-analysis-status" class="status-info" style="display: none;">
            ğŸ¤– LM Analizi: <span id="lm-status-text">Kontrol ediliyor...</span>
        </div>
    </div>
    
    <div id="map"></div>
    
    <div class="legend">
        <button class="legend-toggle" onclick="toggleLegend()" title="AÃ§Ä±klamayÄ± gizle/gÃ¶ster">âˆ’</button>
        <h4>ğŸ¯ Risk Seviyeleri</h4>
        <div class="legend-item">
            <div class="legend-color" style="background-color: green;"></div>
            <span>DÃ¼ÅŸÃ¼k Risk</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: orange;"></div>
            <span>Orta Risk</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: red;"></div>
            <span>YÃ¼ksek Risk</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: purple; border: 2px dashed #333;"></div>
            <span>YayÄ±lma Riski</span>
        </div>
        <p>ğŸ“ Alanlara dokunarak detaylÄ± bilgi alabilirsiniz</p>
    </div>
    
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Header ve legend toggle fonksiyonlarÄ±
        function toggleHeader() {
            const header = document.querySelector('.header');
            const toggleBtn = document.querySelector('.header-toggle');
            header.classList.toggle('minimized');
            toggleBtn.textContent = header.classList.contains('minimized') ? '+' : 'âˆ’';
        }
        
        function toggleLegend() {
            const legend = document.querySelector('.legend');
            const toggleBtn = document.querySelector('.legend-toggle');
            legend.classList.toggle('minimized');
            toggleBtn.textContent = legend.classList.contains('minimized') ? '+' : 'âˆ’';
        }
        
        // Cache durumunu gÃ¼ncelle
        async function updateCacheStatus() {
            try {
                const response = await fetch('/cache_stats');
                const stats = await response.json();
                const total = stats.total_entries;
                const valid = stats.valid_entries;
                const expired = stats.expired_entries;
                let statusText = `ğŸ“Š Cache: ${valid} geÃ§erli`;
                if (expired > 0) {
                    statusText += `, ${expired} sÃ¼resi dolmuÅŸ`;
                }
                if (total > 0) {
                    const hitRate = Math.round((valid / total) * 100);
                    statusText += ` (${hitRate}% hit rate)`;
                }
                document.getElementById('cache-status').innerHTML = statusText;
            } catch (error) {
                document.getElementById('cache-status').innerHTML = 'âŒ Cache durumu alÄ±namadÄ±';
            }
        }

        // Analiz durumunu gÃ¼ncelle
        async function updateAnalysisStatus() {
            try {
                const response = await fetch('/analysis_status');
                const status = await response.json();
                const stats = status.cache_stats;
                let statusText = `ğŸŸ¢ Sunucu Ã§alÄ±ÅŸÄ±yor`;
                if (stats.valid_entries > 0) {
                    statusText += ` - ${stats.valid_entries} analiz hazÄ±r`;
                }
                document.getElementById('analysis-status').innerHTML = statusText;
                // LM analizi durumunu kontrol et
                const lmStatus = status.lm_analysis_status;
                const lmStatusDiv = document.getElementById('lm-analysis-status');
                const lmStatusText = document.getElementById('lm-status-text');
                if (lmStatus) {
                    lmStatusDiv.style.display = 'block';
                    if (lmStatus.running) {
                        lmStatusText.innerHTML = 'ğŸ”„ Ã‡alÄ±ÅŸÄ±yor...';
                        lmStatusText.style.color = '#ff9800';
                    } else if (lmStatus.completed) {
                        lmStatusText.innerHTML = 'âœ… TamamlandÄ±';
                        lmStatusText.style.color = '#4caf50';
                    } else {
                        lmStatusText.innerHTML = 'â¸ï¸ Bekliyor';
                        lmStatusText.style.color = '#666';
                    }
                } else {
                    lmStatusDiv.style.display = 'none';
                }
            } catch (error) {
                document.getElementById('analysis-status').innerHTML = 'âŒ Analiz durumu alÄ±namadÄ±';
                document.getElementById('lm-analysis-status').style.display = 'none';
            }
        }

        // TÃ¼rkiye'nin merkez koordinatlarÄ±
        var map = L.map('map').setView([39.0, 35.0], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Â© OpenStreetMap katkÄ±cÄ±larÄ±'
        }).addTo(map);

        // Cache ve analiz durumunu baÅŸlangÄ±Ã§ta gÃ¼ncelle
        updateCacheStatus();
        updateAnalysisStatus();
        // Periyodik gÃ¼ncelleme (5 saniyede bir)
        setInterval(updateCacheStatus, 5000);
        setInterval(updateAnalysisStatus, 5000);

        // GeoJSON dosyasÄ±nÄ± yÃ¼kle
        fetch('/static/export_with_risk_auto_20250706_220807.geojson')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const featureLayer = L.geoJSON(data, {
                    style: function(feature) {
                        return {
                            color: '#888',
                            fillColor: '#888',
                            weight: 2,
                            fillOpacity: 0.5
                        };
                    },
                    onEachFeature: function (feature, layer) {
                        layer.bindPopup('<div class="popup-content"><div style="text-align: center; color: #666;">ğŸ“Š Analiz yÃ¼kleniyor...</div></div>', {
                            maxWidth: 400,
                            className: 'custom-popup'
                        });
                        
                        layer.on('popupopen', function(e) {
                            const popup = layer.getPopup();
                            if (feature.properties._dynamic_risk) {
                                const data = feature.properties._dynamic_risk;
                                let fireWarn = '';
                                if (data.fire_status === 'active') {
                                    fireWarn = `<div class="fire-warning">ğŸ”¥ Bu alanda <u>aktif yangÄ±n</u> var!</div>`;
                                } else if (data.fire_spread_risk) {
                                    fireWarn = `<div class="spread-warning">âš ï¸ Bu alan <u>yangÄ±nÄ±n yayÄ±labileceÄŸi riskli bÃ¶lgedir!</u></div>`;
                                }
                                
                                let lmExplanation = '';
                                if (data.analysis) {
                                    lmExplanation = `
                                        <div class="lm-analysis">
                                            <strong>ğŸ¤– Yapay Zeka Analizi:</strong><br>
                                            ${data.analysis}
                                            <br><br>
                                            <strong>ğŸ“‹ Analiz AÃ§Ä±klamasÄ±:</strong><br>
                                            Bu analiz, hava durumu verileri, insan faktÃ¶rleri ve coÄŸrafi Ã¶zellikler dikkate alÄ±narak yapÄ±lmÄ±ÅŸtÄ±r. 
                                            Yapay zeka modeli, geÃ§miÅŸ yangÄ±n verileri ve mevcut koÅŸullarÄ± analiz ederek risk seviyesini belirlemiÅŸtir.
                                        </div>
                                    `;
                                }
                                
                                popup.setContent(`
                                    <div class="popup-content">
                                        ${fireWarn}
                                        <h3 class="popup-title">${data.area_type || 'Orman AlanÄ±'}</h3>
                                        
                                        <div class="risk-section risk-combined">
                                            <strong>ğŸ¯ BirleÅŸtirilmiÅŸ Risk:</strong> 
                                            <span class="risk-score" style="color: ${data.combined_risk_color};">
                                                ${data.combined_risk_level} (${data.combined_risk_score})
                                            </span>
                                        </div>
                                        
                                        <div class="risk-section risk-weights">
                                            <strong>âš–ï¸ Dinamik AÄŸÄ±rlÄ±klar:</strong><br>
                                            ğŸŒ¤ï¸ Hava Durumu: %${data.weather_weight}<br>
                                            ğŸ‘¥ Ä°nsan FaktÃ¶rÃ¼: %${data.human_weight}<br>
                                            ğŸ™ï¸ En YakÄ±n Åehir: ${data.nearest_city} (${data.distance_from_city} km)<br>
                                            ğŸï¸ Alan Tipi: ${data.area_type}<br>
                                            ğŸ“ Alan BÃ¼yÃ¼klÃ¼ÄŸÃ¼: ${data.area_size}
                                        </div>
                                        
                                        <div class="risk-section risk-weather">
                                            <strong>ğŸŒ¤ï¸ Hava Durumu Risk:</strong> ${data.weather_risk_score}
                                            <div class="weather-data">
                                                ğŸŒ¡ï¸ SÄ±caklÄ±k: ${data.weather_data.sicaklik}Â°C<br>
                                                ğŸ’§ Nem: ${data.weather_data.nem}%<br>
                                                ğŸ’¨ RÃ¼zgar: ${data.weather_data.ruzgar_hizi} km/h<br>
                                                ğŸŒ§ï¸ YaÄŸÄ±ÅŸ: ${data.weather_data.yagis_7_gun} mm
                                            </div>
                                        </div>
                                        
                                        <div class="risk-section risk-human">
                                            <strong>ğŸ‘¥ Ä°nsan KaynaklÄ± Risk:</strong> ${data.human_risk_score}
                                            ${data.human_risk_explanation ? `<div style="font-size: 12px; color: #666; margin-top: 5px; font-style: italic;">${data.human_risk_explanation}</div>` : ''}
                                        </div>
                                        
                                        ${lmExplanation}
                                        
                                        <div class="update-time">
                                            ğŸ”„ Son gÃ¼ncelleme: ${new Date().toLocaleString('tr-TR')}
                                        </div>
                                    </div>
                                `);
                                popup.update();
                            } else {
                                popup.setContent(`
                                    <div class="popup-content">
                                        <h3 class="popup-title">${feature.properties.name || 'Orman AlanÄ±'}</h3>
                                        <div style="padding: 15px; background-color: #f0f0f0; border-radius: 8px; text-align: center;">
                                            <div style="color: #666; font-size: 14px;">â³ Analiz yapÄ±lÄ±yor...</div>
                                            <div style="margin-top: 8px; font-size: 12px; color: #999;">Bu alan iÃ§in risk analizi henÃ¼z tamamlanmadÄ±.</div>
                                        </div>
                                    </div>
                                `);
                                popup.update();
                            }
                        });
                    }
                }).addTo(map);
                
                const features = featureLayer.getLayers();
                let analyzedCount = 0;
                let cachedCount = 0;
                
                function updateLayerStyle(layer, data) {
                    if (data.fire_status === 'active') {
                        layer.setStyle({ 
                            color: 'red', 
                            weight: 4, 
                            dashArray: '5,5', 
                            fillColor: 'red',
                            fillOpacity: 0.7 
                        });
                    } else if (data.fire_spread_risk) {
                        layer.setStyle({ 
                            color: 'purple', 
                            weight: 4, 
                            dashArray: '2,8', 
                            fillColor: 'purple',
                            fillOpacity: 0.6 
                        });
                    } else {
                        let renk = 'green';
                        if (data.combined_risk_level === 'YÃ¼ksek') renk = 'red';
                        else if (data.combined_risk_level === 'Orta') renk = 'orange';
                        layer.setStyle({ 
                            color: renk, 
                            fillColor: renk,
                            fillOpacity: 0.6,
                            weight: 2
                        });
                    }
                    
                    const popup = layer.getPopup();
                    if (popup && popup.isOpen()) {
                        let fireWarn = '';
                        if (data.fire_status === 'active') {
                            fireWarn = `<div class="fire-warning">ğŸ”¥ Bu alanda <u>aktif yangÄ±n</u> var!</div>`;
                        } else if (data.fire_spread_risk) {
                            fireWarn = `<div class="spread-warning">âš ï¸ Bu alan <u>yangÄ±nÄ±n yayÄ±labileceÄŸi riskli bÃ¶lgedir!</u></div>`;
                        }
                        
                        let lmExplanation = '';
                        if (data.analysis) {
                            lmExplanation = `
                                <div class="lm-analysis">
                                    <strong>ğŸ¤– Yapay Zeka Analizi:</strong><br>
                                    ${data.analysis}
                                    <br><br>
                                    <strong>ğŸ“‹ Analiz AÃ§Ä±klamasÄ±:</strong><br>
                                    Bu analiz, hava durumu verileri, insan faktÃ¶rleri ve coÄŸrafi Ã¶zellikler dikkate alÄ±narak yapÄ±lmÄ±ÅŸtÄ±r. 
                                    Yapay zeka modeli, geÃ§miÅŸ yangÄ±n verileri ve mevcut koÅŸullarÄ± analiz ederek risk seviyesini belirlemiÅŸtir.
                                </div>
                            `;
                        }
                        
                        popup.setContent(`
                            <div class="popup-content">
                                ${fireWarn}
                                <h3 class="popup-title">${data.area_type || 'Orman AlanÄ±'}</h3>
                                
                                <div class="risk-section risk-combined">
                                    <strong>ğŸ¯ BirleÅŸtirilmiÅŸ Risk:</strong> 
                                    <span class="risk-score" style="color: ${data.combined_risk_color};">
                                        ${data.combined_risk_level} (${data.combined_risk_score})
                                    </span>
                                </div>
                                
                                <div class="risk-section risk-weights">
                                    <strong>âš–ï¸ Dinamik AÄŸÄ±rlÄ±klar:</strong><br>
                                    ğŸŒ¤ï¸ Hava Durumu: %${data.weather_weight}<br>
                                    ğŸ‘¥ Ä°nsan FaktÃ¶rÃ¼: %${data.human_weight}<br>
                                    ğŸ™ï¸ En YakÄ±n Åehir: ${data.nearest_city} (${data.distance_from_city} km)<br>
                                    ğŸï¸ Alan Tipi: ${data.area_type}<br>
                                    ğŸ“ Alan BÃ¼yÃ¼klÃ¼ÄŸÃ¼: ${data.area_size}
                                </div>
                                
                                <div class="risk-section risk-weather">
                                    <strong>ğŸŒ¤ï¸ Hava Durumu Risk:</strong> ${data.weather_risk_score}
                                    <div class="weather-data">
                                        ğŸŒ¡ï¸ SÄ±caklÄ±k: ${data.weather_data.sicaklik}Â°C<br>
                                        ğŸ’§ Nem: ${data.weather_data.nem}%<br>
                                        ğŸ’¨ RÃ¼zgar: ${data.weather_data.ruzgar_hizi} km/h<br>
                                        ğŸŒ§ï¸ YaÄŸÄ±ÅŸ: ${data.weather_data.yagis_7_gun} mm
                                    </div>
                                </div>
                                
                                <div class="risk-section risk-human">
                                    <strong>ğŸ‘¥ Ä°nsan KaynaklÄ± Risk:</strong> ${data.human_risk_score}
                                    ${data.human_risk_explanation ? `<div style="font-size: 12px; color: #666; margin-top: 5px; font-style: italic;">${data.human_risk_explanation}</div>` : ''}
                                </div>
                                
                                ${lmExplanation}
                                
                                <div class="update-time">
                                    ğŸ”„ Son gÃ¼ncelleme: ${new Date().toLocaleString('tr-TR')}
                                </div>
                            </div>
                        `);
                        popup.update();
                    }
                }

                async function analyzeSequentially() {
                    console.log("Analiz baÅŸlatÄ±lÄ±yor...");
                    
                    const cachePromises = [];
                    for (let i = 0; i < features.length; i++) {
                        const layer = features[i];
                        const feature = layer.feature;
                        const props = feature.properties;
                        
                        const promise = fetch('/analyze_lm', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                centroid_lat: props.centroid_lat,
                                centroid_lon: props.centroid_lon,
                                area: props.area,
                                landuse: props.landuse,
                                name: props.name
                            })
                        }).then(async (res) => {
                            const data = await res.json();
                            const isCached = res.headers.get('X-Cache-Hit') === 'true';
                            
                            if (isCached) {
                                cachedCount++;
                                console.log(`Cache hit: ${props.name || 'Alan'} - Hemen gÃ¶steriliyor`);
                                updateLayerStyle(layer, data);
                                feature.properties._dynamic_risk = data;
                            } else {
                                analyzedCount++;
                                console.log(`Yeni analiz: ${props.name || 'Alan'} - Yeni analiz yapÄ±lÄ±yor`);
                                await new Promise(resolve => setTimeout(resolve, 200));
                                updateLayerStyle(layer, data);
                                feature.properties._dynamic_risk = data;
                            }
                            
                            return { layer, data, isCached };
                        }).catch(err => {
                            console.error(`Hata: ${props.name}`, err);
                            layer.setStyle({ 
                                color: '#888', 
                                fillColor: '#888',
                                weight: 2, 
                                fillOpacity: 0.5 
                            });
                            return { layer, error: true };
                        });
                        
                        cachePromises.push(promise);
                    }
                    
                    await Promise.all(cachePromises);
                    
                    for (let i = 0; i < features.length; i++) {
                        const layer = features[i];
                        const feature = layer.feature;
                        const props = feature.properties;
                        
                        if (!feature.properties._dynamic_risk) {
                            try {
                                const res = await fetch('/analyze_lm', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        centroid_lat: props.centroid_lat,
                                        centroid_lon: props.centroid_lon,
                                        area: props.area,
                                        landuse: props.landuse,
                                        name: props.name
                                    })
                                });
                                const data = await res.json();
                                    
                                analyzedCount++;
                                console.log(`Yeni analiz: ${props.name || 'Alan'}`);
                                
                                updateLayerStyle(layer, data);
                                feature.properties._dynamic_risk = data;
                                
                                await new Promise(resolve => setTimeout(resolve, 200));
                                
                            } catch (err) {
                                console.error(`Hata: ${props.name}`, err);
                                layer.setStyle({ 
                                    color: '#888', 
                                    fillColor: '#888',
                                    weight: 2, 
                                    fillOpacity: 0.5 
                                });
                            }
                        }
                    }
                }
                
                // Analiz baÅŸlat
                setTimeout(() => {
                    analyzeSequentially().then(() => {
                        updateCacheStatus();
                        updateAnalysisStatus();
                        console.log(`Analiz tamamlandÄ±! ${analyzedCount} yeni, ${cachedCount} cache`);
                    }).catch(err => {
                        console.error('Analiz hatasÄ±:', err);
                    });
                }, 100);
            })
            .catch(error => {
                document.body.innerHTML = '<div style="color:red;font-size:18px;text-align:center;margin-top:40px;padding:20px;">âŒ Harita verileri yÃ¼klenemedi. LÃ¼tfen daha sonra tekrar deneyin.</div>';
            });
    });
    </script>
</body>
</html> 